@page "/edit"
@using System
@using System.Net.Http.Json
@using System.Linq
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using ClosedXML.Excel
@inject HttpClient Http
@inject NavigationManager NavManager
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</PageTitle>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center align-items-start gap-2 mb-4">
    <h1 class="mb-0">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h1>
    <button class="btn btn-outline-secondary" @onclick="RefreshAsync" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        }
        <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
    </button>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <div class="fw-semibold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</div>
            <div class="text-muted small">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
        </div>
        @if (excelSheets.Count > 0)
        {
            <button type="button"
                    class="btn btn-outline-danger btn-sm"
                    disabled="@(isProcessingExcel || isExportingExcel)"
                    @onclick="ResetExcelEditor">
                ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        }
    </div>
    <div class="card-body">
        <div class="row g-2 align-items-center mb-3">
            <div class="col-12 col-md-auto">
                <InputFile OnChange="HandleExcelSelected" accept=".xlsx,.xlsm,.xls" disabled="@isProcessingExcel" />
            </div>
            <div class="col">
                @if (!string.IsNullOrEmpty(excelFileName))
                {
                    <div class="text-muted small">‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: @excelFileName</div>
                }
                else
                {
                    <div class="text-muted small">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx, .xlsm ‡πÅ‡∏•‡∏∞ .xls (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î @ExcelSizeLimitText)</div>
                }
            </div>
            <div class="col-12 col-md-auto d-flex">
                <button type="button"
                        class="btn btn-success w-100"
                        disabled="@(!CanDownloadExcel)"
                        @onclick="DownloadExcelAsync">
                    @if (isExportingExcel)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                </button>
            </div>
        </div>

        @if (isProcessingExcel)
        {
            <div class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå Excel...</div>
        }
        else
        {
            if (!string.IsNullOrEmpty(excelErrorMessage))
            {
                <div class="alert alert-danger">@excelErrorMessage</div>
            }

            if (excelSheets.Count == 0)
            {
                <div class="text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            }
            else if (ActiveExcelSheet is not null)
            {
                var sheet = ActiveExcelSheet!;
                <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                    <label class="form-label mb-0 me-2">‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô:</label>
                    <div class="btn-group btn-group-sm" role="group">
                        @for (var i = 0; i < excelSheets.Count; i++)
                        {
                            <button type="button"
                                    class="btn @(i == activeSheetIndex ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="() => SelectExcelSheet(i)">
                                @excelSheets[i].DisplayName
                            </button>
                        }
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="AddExcelRow">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="AddExcelColumn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
                </div>

                <div class="table-responsive excel-editor-table mb-3">
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="text-center excel-index-column">#</th>
                                @for (var col = 0; col < sheet.ColumnCount; col++)
                                {
                                    <th scope="col" class="text-center">@GetExcelColumnName(col)</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @for (var row = 0; row < sheet.Rows.Count; row++)
                            {
                                <tr>
                                    <th scope="row" class="text-center excel-index-column">@(@row + 1)</th>
                                    @for (var col = 0; col < sheet.ColumnCount; col++)
                                    {
                                        <td>
                                            <input class="form-control form-control-sm"
                                                   value="@GetExcelCellValue(sheet, row, col)"
                                                   @onchange="e => UpdateExcelCell(sheet, row, col, e)" />
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="text-muted small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡πÉ‡∏´‡∏°‡πà</div>
            }
        }
    </div>
    @if (!string.IsNullOrEmpty(excelInfoMessage))
    {
        <div class="card-footer text-success">@excelInfoMessage</div>
    }
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <ul class="nav nav-tabs search-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button type="button"
                        role="tab"
                        class="@GetTabButtonClass(SearchTab.Folder)"
                        @onclick="() => SetSearchTab(SearchTab.Folder)"
                        aria-selected="@(activeTab == SearchTab.Folder)">
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button"
                        role="tab"
                        class="@GetTabButtonClass(SearchTab.Document)"
                        @onclick="() => SetSearchTab(SearchTab.Document)"
                        aria-selected="@(activeTab == SearchTab.Document)">
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </button>
            </li>
        </ul>

        <div class="row g-2 align-items-center mb-3">
            <div class="col-12 col-md-6">
                <div class="input-group">
                    <span class="input-group-text">üîç</span>
                    <input class="form-control"
                           placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
                           @bind-value="searchTerm"
                           @bind-value:event="oninput"
                           aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" />
                </div>
            </div>
            <div class="col-12 col-md-6 text-md-end text-muted small">
                @if (activeTab == SearchTab.Folder)
                {
                    <span>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: @GetFolderResultCount()</span>
                }
                else
                {
                    <span>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: @GetDocumentResultCount()</span>
                }
            </div>
        </div>

        <div class="search-results">
            @if (string.IsNullOrWhiteSpace(searchTerm))
            {
                <div class="text-muted">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
            }
            else if (activeTab == SearchTab.Folder)
            {
                var results = FilteredFolderResults.ToList();
                if (results.Count == 0)
                {
                    <div class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö "@searchTerm"</div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var result in results)
                        {
                            <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                                <div>
                                    <div class="fw-semibold">@result.DisplayName</div>
                                    <div class="small text-muted">@result.DisplayPath</div>
                                </div>
                                <div class="d-flex flex-wrap gap-2 text-muted small">
                                    <span>‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏Å‡∏¥‡πà‡∏á: @result.PdfCount</span>
                                    <span>‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°: @result.TotalPdfCount</span>
                                    <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: @FormatDate(result.LastModifiedUtc)</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                var results = FilteredDocumentResults.ToList();
                if (results.Count == 0)
                {
                    <div class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö "@searchTerm"</div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var result in results)
                        {
                            <div class="list-group-item d-flex flex-column gap-1">
                                <div class="d-flex justify-content-between flex-wrap gap-2 align-items-start">
                                    <div>
                                        <div class="fw-semibold">@result.BaseName</div>
                                        <div class="small text-muted">@result.DisplayPath</div>
                                    </div>
                                    <div class="text-muted small text-end">
                                        <div>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: @result.VersionCount</div>
                                        @if (result.LatestDivision.HasValue)
                                        {
                                            <div>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: Division @result.LatestDivision.Value.ToString("D2")</div>
                                        }
                                        <div>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: @FormatDate(result.LatestUploadedUtc)</div>
                                    </div>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(result.LatestComment))
                                {
                                    <div class="badge bg-light text-dark align-self-start">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: @result.LatestComment</div>
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </div>
</div>

<style>
    .excel-editor-table {
        overflow: auto;
        border: 1px solid var(--bs-border-color, #dee2e6);
        border-radius: 0.75rem;
    }

    .excel-editor-table table {
        margin-bottom: 0;
        min-width: 40rem;
    }

    .excel-editor-table .form-control {
        min-width: 6rem;
    }

    .excel-index-column {
        width: 3rem;
        white-space: nowrap;
    }

    .search-tabs .nav-item button {
        border: none;
        border-bottom: 2px solid transparent;
        background: none;
        padding: 0.5rem 1rem;
        font-weight: 500;
        color: var(--bs-secondary, #6c757d);
        cursor: pointer;
    }

    .search-tabs .nav-item button.active {
        color: var(--bs-primary, #0d6efd);
        border-bottom: 2px solid var(--bs-primary, #0d6efd);
    }

    .search-results .list-group-item {
        border-left: none;
        border-right: none;
    }

    .search-results .list-group-item:first-child {
        border-top: none;
    }

    .search-results .list-group-item:last-child {
        border-bottom: none;
    }

    .branch-tree {
        position: relative;
        padding-left: 0.5rem;
    }

    .branch-node {
        position: relative;
    }

    .branch-card {
        position: relative;
        background-color: #ffffff;
        border-radius: 0.85rem;
        border: 1px solid var(--bs-border-color, #dee2e6);
        box-shadow: 0 0.25rem 0.5rem rgba(15, 23, 42, 0.08);
        margin-left: 1.5rem;
        margin-bottom: 1.25rem;
        padding: 1.25rem;
    }

    .branch-card::before {
        content: '';
        position: absolute;
        left: -1.05rem;
        top: 1.35rem;
        width: 0.7rem;
        height: 0.7rem;
        border-radius: 999px;
        background-color: var(--bs-primary, #0d6efd);
        box-shadow: 0 0 0 4px #ffffff;
    }

    .branch-card::after {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 1.65rem;
        width: 1.5rem;
        height: 2px;
        background-color: var(--bs-border-color, #d0d7de);
    }

    .branch-card.latest {
        border-color: rgba(255, 193, 7, 0.45);
        box-shadow: 0 0.35rem 0.75rem rgba(255, 193, 7, 0.25);
    }

    .branch-card.latest::before {
        background-color: var(--bs-warning, #ffc107);
    }

    .branch-card.latest::after {
        background-color: rgba(255, 193, 7, 0.5);
    }

    .branch-node.depth-0 > .branch-card {
        border-left: 4px solid var(--bs-primary, #0d6efd);
        margin-left: 0.75rem;
    }

    .branch-node.depth-0 > .branch-card::before {
        left: -0.8rem;
        top: 1.5rem;
        background-color: var(--bs-success, #198754);
    }

    .branch-node.depth-0 > .branch-card::after {
        display: none;
    }

    .branch-children {
        position: relative;
        margin-left: 2rem;
        padding-left: 1.5rem;
        border-left: 2px solid var(--bs-border-color, #d0d7de);
    }

    .branch-title {
        font-size: 1.05rem;
    }

    .branch-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .branch-metrics > div {
        background-color: rgba(13, 110, 253, 0.08);
        border-radius: 0.65rem;
        padding: 0.4rem 0.75rem;
        color: var(--bs-primary, #0d6efd);
        font-weight: 500;
    }

    .branch-metrics > div:nth-child(2) {
        background-color: rgba(25, 135, 84, 0.08);
        color: var(--bs-success, #198754);
    }

    .branch-metrics > div:nth-child(3) {
        background-color: rgba(108, 117, 125, 0.1);
        color: var(--bs-secondary, #6c757d);
    }

    .branch-recent span {
        display: inline-block;
        margin-right: 0.25rem;
    }

    .branch-recent span + span::before {
        content: '‚Ä¢';
        margin-right: 0.25rem;
        color: var(--bs-secondary, #6c757d);
    }

    .document-timeline {
        position: relative;
        background-color: #f8f9fa;
        border-radius: 1rem;
        border: 1px solid var(--bs-border-color, #dee2e6);
        padding: 1.25rem 1.5rem;
    }

    .document-name {
        font-size: 1rem;
    }

    .version-timeline {
        position: relative;
        margin-left: 0.35rem;
        padding-left: 1.5rem;
        border-left: 2px solid var(--bs-border-color, #d0d7de);
    }

    .version-node {
        position: relative;
        margin-bottom: 1.15rem;
    }

    .version-node:last-child {
        margin-bottom: 0;
    }

    .version-node::before {
        content: '';
        position: absolute;
        left: -1.05rem;
        top: 0.75rem;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        background-color: var(--bs-primary, #0d6efd);
        box-shadow: 0 0 0 4px #ffffff;
    }

    .version-node.latest::before {
        background-color: var(--bs-success, #198754);
    }

    .version-content {
        background-color: #ffffff;
        border-radius: 0.85rem;
        border: 1px solid var(--bs-border-color, #dee2e6);
        padding: 0.9rem 1.1rem;
        box-shadow: 0 0.25rem 0.5rem rgba(15, 23, 42, 0.05);
    }

    .version-node.latest .version-content {
        border-color: rgba(25, 135, 84, 0.35);
        box-shadow: 0 0.3rem 0.6rem rgba(25, 135, 84, 0.2);
        background-color: rgba(25, 135, 84, 0.08);
    }

    .version-comment {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.65rem;
        background-color: rgba(13, 110, 253, 0.08);
        color: var(--bs-body-color, #212529);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    @@media (max-width: 767.98px) {
        .branch-children {
            border-left: none;
        }

        .branch-card {
            margin-left: 0;
        }

        .branch-card::before {
            left: -0.4rem;
        }

        .branch-card::after {
            display: none;
        }

        .document-timeline {
            padding: 1rem;
        }

        .version-timeline {
            margin-left: 0;
            padding-left: 1.1rem;
        }

        .version-node::before {
            left: -0.85rem;
        }
    }
</style>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}
else if (isLoading)
{
    <div class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...</div>
}
else if (lineStatuses is null || lineStatuses.Count == 0)
{
    <div class="alert alert-info" role="alert">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
}
else
{
    foreach (var line in GetOrderedLineStatuses())
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="fs-5 fw-semibold">@line.Line</div>
                @if (!string.IsNullOrEmpty(line.ErrorMessage))
                {
                    <span class="badge bg-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                }
                else if (line.Root is not null)
                {
                    <span class="badge bg-primary">@line.Root.Status</span>
                }
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(line.ErrorMessage))
                {
                    <div class="alert alert-danger mb-0">@line.ErrorMessage</div>
                }
                else if (line.Root is null)
                {
                    <div class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ</div>
                }
                else
                {
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-4">
                            <div class="text-muted text-uppercase small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div class="fw-semibold">@line.Root.TotalPdfCount</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="text-muted text-uppercase small">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                            <div class="fw-semibold">@FormatDate(line.Root.LastModifiedUtc)</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="text-muted text-uppercase small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                            <div class="fw-semibold">@line.Root.Status</div>
                        </div>
                    </div>

                    <div class="branch-tree mt-3">
                        @RenderBranchNode(line.Root, 0, isLatest: true)
                    </div>
                }
            </div>
        </div>
    }
}

@code {
    private const long MaxExcelUploadBytes = 20L * 1024 * 1024;
    private readonly List<ExcelSheetModel> excelSheets = new();
    private int activeSheetIndex = -1;
    private string? excelFileName;
    private bool isProcessingExcel;
    private bool isExportingExcel;
    private string? excelErrorMessage;
    private string? excelInfoMessage;

    private ExcelSheetModel? ActiveExcelSheet
        => activeSheetIndex >= 0 && activeSheetIndex < excelSheets.Count ? excelSheets[activeSheetIndex] : null;

    private bool CanDownloadExcel => excelSheets.Count > 0 && !isProcessingExcel && !isExportingExcel;

    private string ExcelSizeLimitText => $"{MaxExcelUploadBytes / (1024 * 1024)} MB";

    private async Task HandleExcelSelected(InputFileChangeEventArgs e)
    {
        excelErrorMessage = null;
        excelInfoMessage = null;

        if (e.FileCount == 0 || e.File is null)
        {
            excelErrorMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
            return;
        }

        var file = e.File;
        var extension = Path.GetExtension(file.Name);
        if (string.IsNullOrWhiteSpace(extension) || !IsSupportedExcelExtension(extension))
        {
            excelErrorMessage = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .xlsx, .xlsm ‡∏´‡∏£‡∏∑‡∏≠ .xls";
            return;
        }

        if (file.Size > MaxExcelUploadBytes)
        {
            excelErrorMessage = $"‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏ô {ExcelSizeLimitText}";
            return;
        }

        isProcessingExcel = true;
        excelFileName = file.Name;
        excelSheets.Clear();
        activeSheetIndex = -1;

        try
        {
            await LoadExcelFromFileAsync(file);

            if (excelSheets.Count == 0)
            {
                excelInfoMessage = "‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô";
            }
            else
            {
                activeSheetIndex = 0;
                excelInfoMessage = $"‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå {excelFileName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            }
        }
        catch (Exception ex)
        {
            excelSheets.Clear();
            activeSheetIndex = -1;
            excelErrorMessage = $"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå Excel: {ex.Message}";
        }
        finally
        {
            isProcessingExcel = false;
        }
    }

    private async Task LoadExcelFromFileAsync(IBrowserFile file)
    {
        await using var readStream = file.OpenReadStream(MaxExcelUploadBytes);
        using var memoryStream = new MemoryStream();
        await readStream.CopyToAsync(memoryStream);
        memoryStream.Position = 0;

        using var workbook = new XLWorkbook(memoryStream);
        var index = 0;
        foreach (var worksheet in workbook.Worksheets)
        {
            var model = ConvertWorksheet(worksheet, index);
            excelSheets.Add(model);
            index++;
        }
    }

    private static ExcelSheetModel ConvertWorksheet(IXLWorksheet worksheet, int index)
    {
        var baseName = string.IsNullOrWhiteSpace(worksheet.Name) ? $"Sheet {index + 1}" : worksheet.Name;
        var model = new ExcelSheetModel
        {
            Name = baseName,
            DisplayName = baseName
        };

        var usedRange = worksheet.RangeUsed();
        if (usedRange is null)
        {
            model.ColumnCount = 1;
            model.Rows.Add(new List<string?> { string.Empty });
            return model;
        }

        var rowCount = usedRange.RowCount();
        var columnCount = usedRange.ColumnCount();
        model.ColumnCount = Math.Max(columnCount, 1);

        for (var rowIndex = 1; rowIndex <= rowCount; rowIndex++)
        {
            var row = new List<string?>(model.ColumnCount);
            for (var columnIndex = 1; columnIndex <= model.ColumnCount; columnIndex++)
            {
                if (columnIndex <= columnCount)
                {
                    var cell = usedRange.Cell(rowIndex, columnIndex);
                    row.Add(cell?.GetFormattedString() ?? string.Empty);
                }
                else
                {
                    row.Add(string.Empty);
                }
            }

            model.Rows.Add(row);
        }

        if (model.Rows.Count == 0)
        {
            model.Rows.Add(new List<string?>(Enumerable.Repeat<string?>(string.Empty, model.ColumnCount)));
        }

        return model;
    }

    private void SelectExcelSheet(int index)
    {
        if (index < 0 || index >= excelSheets.Count)
        {
            return;
        }

        activeSheetIndex = index;
    }

    private void AddExcelRow()
    {
        if (ActiveExcelSheet is not { } sheet)
        {
            return;
        }

        var newRow = Enumerable.Repeat<string?>(string.Empty, sheet.ColumnCount).ToList();
        sheet.Rows.Add(newRow);
    }

    private void AddExcelColumn()
    {
        if (ActiveExcelSheet is not { } sheet)
        {
            return;
        }

        sheet.ColumnCount++;
        foreach (var row in sheet.Rows)
        {
            EnsureRowLength(row, sheet.ColumnCount);
        }
    }

    private void UpdateExcelCell(ExcelSheetModel sheet, int rowIndex, int columnIndex, ChangeEventArgs change)
    {
        if (rowIndex < 0 || rowIndex >= sheet.Rows.Count)
        {
            return;
        }

        if (columnIndex < 0 || columnIndex >= sheet.ColumnCount)
        {
            return;
        }

        var row = sheet.Rows[rowIndex];
        EnsureRowLength(row, sheet.ColumnCount);
        row[columnIndex] = change.Value?.ToString() ?? string.Empty;
    }

    private static void EnsureRowLength(List<string?> row, int length)
    {
        while (row.Count < length)
        {
            row.Add(string.Empty);
        }
    }

    private static bool IsSupportedExcelExtension(string extension)
        => extension.Equals(".xlsx", StringComparison.OrdinalIgnoreCase)
           || extension.Equals(".xlsm", StringComparison.OrdinalIgnoreCase)
           || extension.Equals(".xls", StringComparison.OrdinalIgnoreCase);

    private static string GetExcelCellValue(ExcelSheetModel sheet, int rowIndex, int columnIndex)
    {
        if (rowIndex < 0 || rowIndex >= sheet.Rows.Count)
        {
            return string.Empty;
        }

        var row = sheet.Rows[rowIndex];
        if (columnIndex < 0 || columnIndex >= row.Count)
        {
            return string.Empty;
        }

        return row[columnIndex] ?? string.Empty;
    }

    private static string GetExcelColumnName(int columnIndex)
    {
        var index = columnIndex + 1;
        var result = string.Empty;

        while (index > 0)
        {
            var remainder = (index - 1) % 26;
            result = (char)('A' + remainder) + result;
            index = (index - 1) / 26;
        }

        return result;
    }

    private async Task DownloadExcelAsync()
    {
        if (!CanDownloadExcel)
        {
            return;
        }

        isExportingExcel = true;

        try
        {
            using var workbook = new XLWorkbook();

            for (var index = 0; index < excelSheets.Count; index++)
            {
                var sheet = excelSheets[index];
                var worksheet = workbook.Worksheets.Add(SanitizeWorksheetName(sheet.Name, index));

                for (var rowIndex = 0; rowIndex < sheet.Rows.Count; rowIndex++)
                {
                    var row = sheet.Rows[rowIndex];
                    EnsureRowLength(row, sheet.ColumnCount);

                    for (var columnIndex = 0; columnIndex < sheet.ColumnCount; columnIndex++)
                    {
                        worksheet.Cell(rowIndex + 1, columnIndex + 1).Value = row[columnIndex] ?? string.Empty;
                    }
                }
            }

            using var memoryStream = new MemoryStream();
            workbook.SaveAs(memoryStream);
            var base64 = Convert.ToBase64String(memoryStream.ToArray());
            var downloadName = BuildExcelDownloadName();
            await JS.InvokeVoidAsync("excelEditor.downloadFile", downloadName, base64);
            excelInfoMessage = $"‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå {downloadName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            excelErrorMessage = null;
        }
        catch (Exception ex)
        {
            excelErrorMessage = $"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel: {ex.Message}";
        }
        finally
        {
            isExportingExcel = false;
        }
    }

    private string BuildExcelDownloadName()
    {
        if (string.IsNullOrWhiteSpace(excelFileName))
        {
            return "edited.xlsx";
        }

        var name = Path.GetFileNameWithoutExtension(excelFileName);
        return string.Concat(name, "_edited.xlsx");
    }

    private static string SanitizeWorksheetName(string? name, int index)
    {
        var candidate = string.IsNullOrWhiteSpace(name) ? $"Sheet{index + 1}" : name;
        foreach (var invalid in new[] { '\\', '/', '*', '[', ']', ':', '?' })
        {
            candidate = candidate.Replace(invalid, '_');
        }

        if (candidate.Length > 31)
        {
            candidate = candidate[..31];
        }

        return string.IsNullOrWhiteSpace(candidate) ? $"Sheet{index + 1}" : candidate;
    }

    private void ResetExcelEditor()
    {
        excelSheets.Clear();
        activeSheetIndex = -1;
        excelFileName = null;
        excelErrorMessage = null;
        excelInfoMessage = null;
    }

    private sealed class ExcelSheetModel
    {
        public string Name { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public List<List<string?>> Rows { get; } = new();
        public int ColumnCount { get; set; } = 1;
    }

    private List<LineEditStatusResponse>? lineStatuses;
    private bool isLoading = true;
    private string? errorMessage;
    private SearchTab activeTab = SearchTab.Folder;
    private string searchTerm = string.Empty;
    private readonly List<FolderSearchResult> folderIndex = new();
    private readonly List<DocumentSearchResult> documentIndex = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadStatusesAsync();
    }

    private async Task RefreshAsync()
    {
        await LoadStatusesAsync();
    }

    private async Task LoadStatusesAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var endpoint = NavManager.ToAbsoluteUri("/api/edit-status");
            var result = await Http.GetFromJsonAsync<List<LineEditStatusResponse>>(endpoint);
            lineStatuses = (result ?? new List<LineEditStatusResponse>())
                .OrderByDescending(l => l.Root?.LastModifiedUtc ?? DateTime.MinValue)
                .ThenBy(l => l.Line, StringComparer.CurrentCultureIgnoreCase)
                .ToList();
            RebuildSearchIndexes();
        }
        catch (Exception ex)
        {
            errorMessage = $"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ: {ex.Message}";
            lineStatuses = null;
            folderIndex.Clear();
            documentIndex.Clear();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private IEnumerable<LineEditStatusResponse> GetOrderedLineStatuses()
    {
        if (lineStatuses is null)
        {
            return Enumerable.Empty<LineEditStatusResponse>();
        }

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return lineStatuses;
        }

        var term = searchTerm.Trim();

        return lineStatuses
            .Select((line, index) => new
            {
                Line = line,
                Index = index,
                Rank = CalculateLineMatchRank(line, term)
            })
            .OrderBy(entry => entry.Rank)
            .ThenBy(entry => entry.Index)
            .Select(entry => entry.Line);
    }

    private IEnumerable<FolderSearchResult> FilteredFolderResults
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                return folderIndex;
            }

            var term = searchTerm.Trim();
            return folderIndex
                .Select(f => new { Item = f, Rank = CalculateFolderMatchRank(f, term) })
                .Where(entry => entry.Rank < int.MaxValue)
                .OrderBy(entry => entry.Rank)
                .ThenBy(entry => entry.Item.DisplayName, StringComparer.CurrentCultureIgnoreCase)
                .ThenBy(entry => entry.Item.DisplayPath, StringComparer.CurrentCultureIgnoreCase)
                .Select(entry => entry.Item);
        }
    }

    private IEnumerable<DocumentSearchResult> FilteredDocumentResults
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                return documentIndex;
            }

            var term = searchTerm.Trim();
            return documentIndex
                .Select(d => new { Item = d, Rank = CalculateDocumentMatchRank(d, term) })
                .Where(entry => entry.Rank < int.MaxValue)
                .OrderBy(entry => entry.Rank)
                .ThenBy(entry => entry.Item.BaseName, StringComparer.CurrentCultureIgnoreCase)
                .ThenBy(entry => entry.Item.DisplayPath, StringComparer.CurrentCultureIgnoreCase)
                .Select(entry => entry.Item);
        }
    }

    private void SetSearchTab(SearchTab tab) => activeTab = tab;

    private string GetTabButtonClass(SearchTab tab)
        => tab == activeTab ? "nav-link active" : "nav-link";

    private int GetFolderResultCount()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return folderIndex.Count;
        }

        var term = searchTerm.Trim();
        return folderIndex.Count(f => CalculateFolderMatchRank(f, term) < int.MaxValue);
    }

    private int GetDocumentResultCount()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return documentIndex.Count;
        }

        var term = searchTerm.Trim();
        return documentIndex.Count(d => CalculateDocumentMatchRank(d, term) < int.MaxValue);
    }

    private int CalculateLineMatchRank(LineEditStatusResponse line, string term)
    {
        var ranks = new List<int>
        {
            CalculateMatchRank(term, line.Line)
        };

        if (line.Root is not null)
        {
            ranks.Add(CalculateMatchRank(term, line.Root.Name));

            if (line.Root.PathSegments is not null && line.Root.PathSegments.Count > 0)
            {
                var path = string.Join('/', line.Root.PathSegments);
                ranks.Add(CalculateMatchRank(term, path));
            }
        }

        if (activeTab == SearchTab.Document)
        {
            var documentRanks = documentIndex
                .Where(d => string.Equals(d.Line, line.Line, StringComparison.OrdinalIgnoreCase))
                .Select(d => CalculateDocumentMatchRank(d, term))
                .Where(rank => rank < int.MaxValue)
                .DefaultIfEmpty(int.MaxValue)
                .Min();

            ranks.Add(documentRanks);
        }
        else
        {
            var folderRanks = folderIndex
                .Where(f => string.Equals(f.Line, line.Line, StringComparison.OrdinalIgnoreCase))
                .Select(f => CalculateFolderMatchRank(f, term))
                .Where(rank => rank < int.MaxValue)
                .DefaultIfEmpty(int.MaxValue)
                .Min();

            ranks.Add(folderRanks);
        }

        return ranks
            .Where(rank => rank < int.MaxValue)
            .DefaultIfEmpty(int.MaxValue)
            .Min();
    }

    private static int CalculateFolderMatchRank(FolderSearchResult folder, string term)
    {
        var ranks = new[]
        {
            CalculateMatchRank(term, folder.DisplayName),
            CalculateMatchRank(term, folder.DisplayPath)
        };

        return ranks.Min();
    }

    private static int CalculateDocumentMatchRank(DocumentSearchResult document, string term)
    {
        var ranks = new List<int>
        {
            CalculateMatchRank(term, document.BaseName),
            CalculateMatchRank(term, document.DisplayPath)
        };

        if (!string.IsNullOrWhiteSpace(document.LatestComment) && document.LatestComment.Contains(term, StringComparison.OrdinalIgnoreCase))
        {
            ranks.Add(3);
        }
        else
        {
            ranks.Add(int.MaxValue);
        }

        return ranks.Min();
    }

    private static int CalculateMatchRank(string term, string? candidate)
    {
        if (string.IsNullOrWhiteSpace(candidate))
        {
            return int.MaxValue;
        }

        if (string.Equals(candidate, term, StringComparison.OrdinalIgnoreCase))
        {
            return 0;
        }

        if (candidate.StartsWith(term, StringComparison.OrdinalIgnoreCase))
        {
            return 1;
        }

        if (candidate.Contains(term, StringComparison.OrdinalIgnoreCase))
        {
            return 2;
        }

        return int.MaxValue;
    }

    private void RebuildSearchIndexes()
    {
        folderIndex.Clear();
        documentIndex.Clear();

        if (lineStatuses is null)
        {
            return;
        }

        foreach (var line in lineStatuses)
        {
            if (line.Root is null)
            {
                continue;
            }

            IndexBranch(line.Line, line.Root, Array.Empty<string>());
        }
    }

    private void IndexBranch(string line, BranchEditStatusResponse branch, IReadOnlyList<string> parentSegments)
    {
        var segments = parentSegments.ToList();
        if (!string.IsNullOrWhiteSpace(branch.Name))
        {
            var isRoot = parentSegments.Count == 0 && string.Equals(branch.Name, line, StringComparison.OrdinalIgnoreCase);
            if (!isRoot)
            {
                segments.Add(branch.Name);
            }
        }

        var displaySegments = new List<string> { line };
        displaySegments.AddRange(segments);
        var displayPath = string.Join(" / ", displaySegments);
        var displayName = segments.Count > 0 ? segments[^1] : line;

        folderIndex.Add(new FolderSearchResult
        {
            Line = line,
            DisplayName = displayName,
            DisplayPath = displayPath,
            PdfCount = branch.PdfCount,
            TotalPdfCount = branch.TotalPdfCount,
            LastModifiedUtc = branch.LastModifiedUtc
        });

        foreach (var document in branch.Documents ?? Enumerable.Empty<DocumentTimelineResponse>())
        {
            var latest = document.Versions
                .OrderByDescending(v => v.UploadedUtc)
                .ThenByDescending(v => v.Division)
                .FirstOrDefault();

            var baseName = document.BaseName ?? string.Empty;
            documentIndex.Add(new DocumentSearchResult
            {
                Line = line,
                BaseName = baseName,
                DisplayPath = string.Join(" / ", displaySegments.Append(baseName)),
                VersionCount = document.Versions.Count,
                LatestUploadedUtc = latest?.UploadedUtc,
                LatestDivision = latest?.Division,
                LatestComment = latest?.Comment ?? string.Empty
            });
        }

        foreach (var child in branch.Children)
        {
            IndexBranch(line, child, segments);
        }
    }

    private RenderFragment RenderBranchNode(BranchEditStatusResponse branch, int depth, bool isLatest = false)
    {
        return builder =>
        {
            var seq = 0;
            var orderedChildren = OrderBranches(branch.Children);
            var orderedDocuments = (branch.Documents ?? new List<DocumentTimelineResponse>())
                .OrderByDescending(d => d.LatestUploadedUtc ?? DateTime.MinValue)
                .ThenBy(d => d.BaseName, StringComparer.CurrentCultureIgnoreCase)
                .ToList();
            var recentFiles = branch.RecentFiles
                .OrderByDescending(f => f.LastModifiedUtc)
                .Take(3)
                .ToList();

            var nodeClasses = $"branch-node depth-{depth}";

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", nodeClasses);

            var cardClasses = depth == 0 ? "branch-card root-branch" : "branch-card";
            if (isLatest && depth > 0)
            {
                cardClasses += " latest";
            }

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", cardClasses);

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex justify-content-between align-items-start gap-3 flex-wrap");

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column");
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "branch-title fw-semibold");
            builder.AddContent(seq++, branch.Name);
            builder.CloseElement();

            if (branch.PathSegments.Count > 0)
            {
                builder.OpenElement(seq++, "span");
                builder.AddAttribute(seq++, "class", "small text-muted");
                builder.AddContent(seq++, string.Join('/', branch.PathSegments));
                builder.CloseElement();
            }

            if (isLatest && depth > 0)
            {
                builder.OpenElement(seq++, "span");
                builder.AddAttribute(seq++, "class", "badge bg-warning text-dark align-self-start mt-2");
                builder.AddContent(seq++, "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î");
                builder.CloseElement();
            }
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column text-end gap-1");
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "badge rounded-pill bg-light text-dark border branch-badge align-self-end");
            builder.AddContent(seq++, string.IsNullOrEmpty(branch.ErrorMessage) ? branch.Status : "Error");
            builder.CloseElement();
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "small text-muted");
            builder.AddContent(seq++, FormatDate(branch.LastModifiedUtc));
            builder.CloseElement();
            builder.CloseElement();

            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "branch-metrics d-flex flex-wrap gap-2 mb-3");

            builder.OpenElement(seq++, "div");
            builder.AddContent(seq++, $"‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏Å‡∏¥‡πà‡∏á: {branch.PdfCount}");
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddContent(seq++, $"‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°: {branch.TotalPdfCount}");
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddContent(seq++, $"‡∏Å‡∏¥‡πà‡∏á‡∏¢‡πà‡∏≠‡∏¢: {branch.Children.Count}");
            builder.CloseElement();

            builder.CloseElement();

            if (!string.IsNullOrEmpty(branch.ErrorMessage))
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "alert alert-danger mb-0");
                builder.AddContent(seq++, branch.ErrorMessage);
                builder.CloseElement();
            }
            else if (orderedDocuments.Count > 0)
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "document-timelines d-flex flex-column gap-3 mt-3");

                foreach (var document in orderedDocuments)
                {
                    builder.AddContent(seq++, RenderDocumentTimeline(document));
                }

                builder.CloseElement();
            }
            else if (recentFiles.Count > 0)
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "branch-recent small text-muted");
                builder.AddContent(seq++, "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ");

                for (var i = 0; i < recentFiles.Count; i++)
                {
                    var file = recentFiles[i];
                    builder.OpenElement(seq++, "span");
                    builder.AddAttribute(seq++, "class", "text-body-secondary");
                    builder.AddContent(seq++, $"{file.FileName} ({FormatDate(file.LastModifiedUtc)})");
                    builder.CloseElement();
                }

                builder.CloseElement();
            }
            else
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "text-muted small");
                builder.AddContent(seq++, "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ô‡∏Å‡∏¥‡πà‡∏á‡∏ô‡∏µ‡πâ");
                builder.CloseElement();
            }

            builder.CloseElement();

            if (orderedChildren.Any())
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "branch-children");

                for (var i = 0; i < orderedChildren.Count; i++)
                {
                    var child = orderedChildren[i];
                    builder.AddContent(seq++, RenderBranchNode(child, depth + 1, isLatest: i == 0));
                }

                builder.CloseElement();
            }

            builder.CloseElement();
        };
    }

    private RenderFragment RenderDocumentTimeline(DocumentTimelineResponse document)
    {
        return builder =>
        {
            var seq = 0;
            var versions = document.Versions
                .OrderByDescending(v => v.UploadedUtc)
                .ThenByDescending(v => v.Division)
                .ToList();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "document-timeline");

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "document-timeline-header d-flex justify-content-between align-items-start gap-2 flex-wrap mb-2");

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column");
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "document-name fw-semibold");
            builder.AddContent(seq++, document.BaseName);
            builder.CloseElement();
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column align-items-end gap-1");

            if (document.LatestUploadedUtc is DateTime latest)
            {
                builder.OpenElement(seq++, "span");
                builder.AddAttribute(seq++, "class", "small text-muted");
                builder.AddContent(seq++, $"‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {FormatDate(latest)}");
                builder.CloseElement();
            }

            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "badge bg-success text-white");
            builder.AddContent(seq++, $"‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {versions.Count} ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô");
            builder.CloseElement();

            builder.CloseElement();

            builder.CloseElement();

            if (versions.Count > 0)
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "version-timeline");

                for (var i = 0; i < versions.Count; i++)
                {
                    var version = versions[i];
                    var versionClasses = "version-node";
                    if (i == 0)
                    {
                        versionClasses += " latest";
                    }

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", versionClasses);

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", "version-content");

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", "d-flex justify-content-between align-items-start flex-wrap gap-2");

                    builder.OpenElement(seq++, "span");
                    builder.AddAttribute(seq++, "class", "fw-semibold");
                    builder.AddContent(seq++, $"Division {version.Division:D2}");
                    builder.CloseElement();

                    builder.OpenElement(seq++, "span");
                    builder.AddAttribute(seq++, "class", "small text-muted");
                    builder.AddContent(seq++, FormatDate(version.UploadedUtc));
                    builder.CloseElement();

                    builder.CloseElement();

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", "small text-muted");
                    builder.AddContent(seq++, version.FileName);
                    builder.CloseElement();

                    if (!string.IsNullOrWhiteSpace(version.Comment))
                    {
                        builder.OpenElement(seq++, "div");
                        builder.AddAttribute(seq++, "class", "version-comment");
                        builder.AddContent(seq++, version.Comment);
                        builder.CloseElement();
                    }

                    builder.CloseElement();
                    builder.CloseElement();
                }

                builder.CloseElement();
            }

            builder.CloseElement();
        };
    }

    private static List<BranchEditStatusResponse> OrderBranches(IEnumerable<BranchEditStatusResponse> branches)
        => branches
            .OrderByDescending(b => b.LastModifiedUtc ?? DateTime.MinValue)
            .ThenBy(b => b.Name, StringComparer.CurrentCultureIgnoreCase)
            .ToList();

    private static string FormatDate(DateTime? value)
        => value.HasValue ? value.Value.ToLocalTime().ToString("g") : "-";

    private static string FormatDate(DateTime value)
        => value.ToLocalTime().ToString("g");


    private enum SearchTab
    {
        Folder,
        Document
    }

    private sealed class LineEditStatusResponse
    {
        public string Line { get; set; } = string.Empty;
        public BranchEditStatusResponse? Root { get; set; }
        public string? ErrorMessage { get; set; }
    }

    private sealed class BranchEditStatusResponse
    {
        public string Name { get; set; } = string.Empty;
        public List<string> PathSegments { get; set; } = new();
        public int PdfCount { get; set; }
        public int TotalPdfCount { get; set; }
        public DateTime? LastModifiedUtc { get; set; }
        public string Status { get; set; } = string.Empty;
        public List<FileEditStatusResponse> RecentFiles { get; set; } = new();
        public List<DocumentTimelineResponse> Documents { get; set; } = new();
        public List<BranchEditStatusResponse> Children { get; set; } = new();
        public string? ErrorMessage { get; set; }
    }

    private sealed class FileEditStatusResponse
    {
        public string FileName { get; set; } = string.Empty;
        public DateTime LastModifiedUtc { get; set; }
        public long SizeBytes { get; set; }
        public string RelativePath { get; set; } = string.Empty;
    }

    private sealed class DocumentTimelineResponse
    {
        public string BaseName { get; set; } = string.Empty;
        public DateTime? LatestUploadedUtc { get; set; }
        public List<VersionTimelineResponse> Versions { get; set; } = new();
    }

    private sealed class VersionTimelineResponse
    {
        public string FileName { get; set; } = string.Empty;
        public int Division { get; set; }
        public DateTime UploadedUtc { get; set; }
        public string Comment { get; set; } = string.Empty;
        public string RelativePath { get; set; } = string.Empty;
    }

    private sealed class FolderSearchResult
    {
        public string Line { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string DisplayPath { get; set; } = string.Empty;
        public int PdfCount { get; set; }
        public int TotalPdfCount { get; set; }
        public DateTime? LastModifiedUtc { get; set; }
    }

    private sealed class DocumentSearchResult
    {
        public string Line { get; set; } = string.Empty;
        public string BaseName { get; set; } = string.Empty;
        public string DisplayPath { get; set; } = string.Empty;
        public int VersionCount { get; set; }
        public DateTime? LatestUploadedUtc { get; set; }
        public int? LatestDivision { get; set; }
        public string LatestComment { get; set; } = string.Empty;
    }
}

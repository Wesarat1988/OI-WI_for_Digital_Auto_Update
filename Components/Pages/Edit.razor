@page "/edit"
@using System
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http
@inject NavigationManager NavManager

<PageTitle>สถานะแก้ไขเอกสาร</PageTitle>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center align-items-start gap-2 mb-4">
    <h1 class="mb-0">สถานะแก้ไขเอกสาร</h1>
    <button class="btn btn-outline-secondary" @onclick="RefreshAsync" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        }
        <span>รีเฟรช</span>
    </button>
</div>

<style>
    .branch-tree {
        position: relative;
        padding-left: 0.5rem;
    }

    .branch-node {
        position: relative;
    }

    .branch-card {
        position: relative;
        background-color: #ffffff;
        border-radius: 0.85rem;
        border: 1px solid var(--bs-border-color, #dee2e6);
        box-shadow: 0 0.25rem 0.5rem rgba(15, 23, 42, 0.08);
        margin-left: 1.5rem;
        margin-bottom: 1.25rem;
        padding: 1.25rem;
    }

    .branch-card::before {
        content: '';
        position: absolute;
        left: -1.05rem;
        top: 1.35rem;
        width: 0.7rem;
        height: 0.7rem;
        border-radius: 999px;
        background-color: var(--bs-primary, #0d6efd);
        box-shadow: 0 0 0 4px #ffffff;
    }

    .branch-card::after {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 1.65rem;
        width: 1.5rem;
        height: 2px;
        background-color: var(--bs-border-color, #d0d7de);
    }

    .branch-card.latest {
        border-color: rgba(255, 193, 7, 0.45);
        box-shadow: 0 0.35rem 0.75rem rgba(255, 193, 7, 0.25);
    }

    .branch-card.latest::before {
        background-color: var(--bs-warning, #ffc107);
    }

    .branch-card.latest::after {
        background-color: rgba(255, 193, 7, 0.5);
    }

    .branch-node.depth-0 > .branch-card {
        border-left: 4px solid var(--bs-primary, #0d6efd);
        margin-left: 0.75rem;
    }

    .branch-node.depth-0 > .branch-card::before {
        left: -0.8rem;
        top: 1.5rem;
        background-color: var(--bs-success, #198754);
    }

    .branch-node.depth-0 > .branch-card::after {
        display: none;
    }

    .branch-children {
        position: relative;
        margin-left: 2rem;
        padding-left: 1.5rem;
        border-left: 2px solid var(--bs-border-color, #d0d7de);
    }

    .branch-title {
        font-size: 1.05rem;
    }

    .branch-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .branch-metrics > div {
        background-color: rgba(13, 110, 253, 0.08);
        border-radius: 0.65rem;
        padding: 0.4rem 0.75rem;
        color: var(--bs-primary, #0d6efd);
        font-weight: 500;
    }

    .branch-metrics > div:nth-child(2) {
        background-color: rgba(25, 135, 84, 0.08);
        color: var(--bs-success, #198754);
    }

    .branch-metrics > div:nth-child(3) {
        background-color: rgba(108, 117, 125, 0.1);
        color: var(--bs-secondary, #6c757d);
    }

    .branch-recent span {
        display: inline-block;
        margin-right: 0.25rem;
    }

    .branch-recent span + span::before {
        content: '•';
        margin-right: 0.25rem;
        color: var(--bs-secondary, #6c757d);
    }

    .document-timeline {
        position: relative;
        background-color: #f8f9fa;
        border-radius: 1rem;
        border: 1px solid var(--bs-border-color, #dee2e6);
        padding: 1.25rem 1.5rem;
    }

    .document-name {
        font-size: 1rem;
    }

    .version-timeline {
        position: relative;
        margin-left: 0.35rem;
        padding-left: 1.5rem;
        border-left: 2px solid var(--bs-border-color, #d0d7de);
    }

    .version-node {
        position: relative;
        margin-bottom: 1.15rem;
    }

    .version-node:last-child {
        margin-bottom: 0;
    }

    .version-node::before {
        content: '';
        position: absolute;
        left: -1.05rem;
        top: 0.75rem;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        background-color: var(--bs-primary, #0d6efd);
        box-shadow: 0 0 0 4px #ffffff;
    }

    .version-node.latest::before {
        background-color: var(--bs-success, #198754);
    }

    .version-content {
        background-color: #ffffff;
        border-radius: 0.85rem;
        border: 1px solid var(--bs-border-color, #dee2e6);
        padding: 0.9rem 1.1rem;
        box-shadow: 0 0.25rem 0.5rem rgba(15, 23, 42, 0.05);
    }

    .version-node.latest .version-content {
        border-color: rgba(25, 135, 84, 0.35);
        box-shadow: 0 0.3rem 0.6rem rgba(25, 135, 84, 0.2);
        background-color: rgba(25, 135, 84, 0.08);
    }

    .version-comment {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.65rem;
        background-color: rgba(13, 110, 253, 0.08);
        color: var(--bs-body-color, #212529);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    @@media (max-width: 767.98px) {
        .branch-children {
            border-left: none;
        }

        .branch-card {
            margin-left: 0;
        }

        .branch-card::before {
            left: -0.4rem;
        }

        .branch-card::after {
            display: none;
        }

        .document-timeline {
            padding: 1rem;
        }

        .version-timeline {
            margin-left: 0;
            padding-left: 1.1rem;
        }

        .version-node::before {
            left: -0.85rem;
        }
    }
</style>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}
else if (isLoading)
{
    <div class="text-muted">กำลังโหลดสถานะการแก้ไข...</div>
}
else if (lineStatuses is null || lineStatuses.Count == 0)
{
    <div class="alert alert-info" role="alert">ยังไม่มีข้อมูลสถานะการแก้ไข</div>
}
else
{
    foreach (var line in lineStatuses)
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="fs-5 fw-semibold">@line.Line</div>
                @if (!string.IsNullOrEmpty(line.ErrorMessage))
                {
                    <span class="badge bg-danger">ไม่สามารถอ่านข้อมูล</span>
                }
                else if (line.Root is not null)
                {
                    <span class="badge bg-primary">@line.Root.Status</span>
                }
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(line.ErrorMessage))
                {
                    <div class="alert alert-danger mb-0">@line.ErrorMessage</div>
                }
                else if (line.Root is null)
                {
                    <div class="text-muted">ไม่มีข้อมูลสถานะสำหรับโฟลเดอร์นี้</div>
                }
                else
                {
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-4">
                            <div class="text-muted text-uppercase small">จำนวนไฟล์ทั้งหมด</div>
                            <div class="fw-semibold">@line.Root.TotalPdfCount</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="text-muted text-uppercase small">อัปเดตล่าสุด</div>
                            <div class="fw-semibold">@FormatDate(line.Root.LastModifiedUtc)</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="text-muted text-uppercase small">สถานะ</div>
                            <div class="fw-semibold">@line.Root.Status</div>
                        </div>
                    </div>

                    <div class="branch-tree mt-3">
                        @RenderBranchNode(line.Root, 0, isLatest: true)
                    </div>
                }
            </div>
        </div>
    }
}

@code {
    private List<LineEditStatusResponse>? lineStatuses;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatusesAsync();
    }

    private async Task RefreshAsync()
    {
        await LoadStatusesAsync();
    }

    private async Task LoadStatusesAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var endpoint = NavManager.ToAbsoluteUri("/api/edit-status");
            var result = await Http.GetFromJsonAsync<List<LineEditStatusResponse>>(endpoint);
            lineStatuses = (result ?? new List<LineEditStatusResponse>())
                .OrderByDescending(l => l.Root?.LastModifiedUtc ?? DateTime.MinValue)
                .ThenBy(l => l.Line, StringComparer.CurrentCultureIgnoreCase)
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"ไม่สามารถโหลดสถานะแก้ไขได้: {ex.Message}";
            lineStatuses = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private RenderFragment RenderBranchNode(BranchEditStatusResponse branch, int depth, bool isLatest = false)
    {
        return builder =>
        {
            var seq = 0;
            var orderedChildren = OrderBranches(branch.Children);
            var orderedDocuments = (branch.Documents ?? new List<DocumentTimelineResponse>())
                .OrderByDescending(d => d.LatestUploadedUtc ?? DateTime.MinValue)
                .ThenBy(d => d.BaseName, StringComparer.CurrentCultureIgnoreCase)
                .ToList();
            var recentFiles = branch.RecentFiles
                .OrderByDescending(f => f.LastModifiedUtc)
                .Take(3)
                .ToList();

            var nodeClasses = $"branch-node depth-{depth}";

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", nodeClasses);

            var cardClasses = depth == 0 ? "branch-card root-branch" : "branch-card";
            if (isLatest && depth > 0)
            {
                cardClasses += " latest";
            }

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", cardClasses);

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex justify-content-between align-items-start gap-3 flex-wrap");

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column");
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "branch-title fw-semibold");
            builder.AddContent(seq++, branch.Name);
            builder.CloseElement();

            if (branch.PathSegments.Count > 0)
            {
                builder.OpenElement(seq++, "span");
                builder.AddAttribute(seq++, "class", "small text-muted");
                builder.AddContent(seq++, string.Join('/', branch.PathSegments));
                builder.CloseElement();
            }

            if (isLatest && depth > 0)
            {
                builder.OpenElement(seq++, "span");
                builder.AddAttribute(seq++, "class", "badge bg-warning text-dark align-self-start mt-2");
                builder.AddContent(seq++, "ล่าสุด");
                builder.CloseElement();
            }
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column text-end gap-1");
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "badge rounded-pill bg-light text-dark border branch-badge align-self-end");
            builder.AddContent(seq++, string.IsNullOrEmpty(branch.ErrorMessage) ? branch.Status : "Error");
            builder.CloseElement();
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "small text-muted");
            builder.AddContent(seq++, FormatDate(branch.LastModifiedUtc));
            builder.CloseElement();
            builder.CloseElement();

            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "branch-metrics d-flex flex-wrap gap-2 mb-3");

            builder.OpenElement(seq++, "div");
            builder.AddContent(seq++, $"ไฟล์ในกิ่ง: {branch.PdfCount}");
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddContent(seq++, $"ไฟล์รวม: {branch.TotalPdfCount}");
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddContent(seq++, $"กิ่งย่อย: {branch.Children.Count}");
            builder.CloseElement();

            builder.CloseElement();

            if (!string.IsNullOrEmpty(branch.ErrorMessage))
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "alert alert-danger mb-0");
                builder.AddContent(seq++, branch.ErrorMessage);
                builder.CloseElement();
            }
            else if (orderedDocuments.Count > 0)
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "document-timelines d-flex flex-column gap-3 mt-3");

                foreach (var document in orderedDocuments)
                {
                    builder.AddContent(seq++, RenderDocumentTimeline(document));
                }

                builder.CloseElement();
            }
            else if (recentFiles.Count > 0)
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "branch-recent small text-muted");
                builder.AddContent(seq++, "อัปเดตล่าสุด: ");

                for (var i = 0; i < recentFiles.Count; i++)
                {
                    var file = recentFiles[i];
                    builder.OpenElement(seq++, "span");
                    builder.AddAttribute(seq++, "class", "text-body-secondary");
                    builder.AddContent(seq++, $"{file.FileName} ({FormatDate(file.LastModifiedUtc)})");
                    builder.CloseElement();
                }

                builder.CloseElement();
            }
            else
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "text-muted small");
                builder.AddContent(seq++, "ยังไม่มีไฟล์ PDF ในกิ่งนี้");
                builder.CloseElement();
            }

            builder.CloseElement();

            if (orderedChildren.Any())
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "branch-children");

                for (var i = 0; i < orderedChildren.Count; i++)
                {
                    var child = orderedChildren[i];
                    builder.AddContent(seq++, RenderBranchNode(child, depth + 1, isLatest: i == 0));
                }

                builder.CloseElement();
            }

            builder.CloseElement();
        };
    }

    private RenderFragment RenderDocumentTimeline(DocumentTimelineResponse document)
    {
        return builder =>
        {
            var seq = 0;
            var versions = document.Versions
                .OrderByDescending(v => v.UploadedUtc)
                .ThenByDescending(v => v.Division)
                .ToList();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "document-timeline");

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "document-timeline-header d-flex justify-content-between align-items-start gap-2 flex-wrap mb-2");

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column");
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "document-name fw-semibold");
            builder.AddContent(seq++, document.BaseName);
            builder.CloseElement();
            builder.CloseElement();

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "d-flex flex-column align-items-end gap-1");

            if (document.LatestUploadedUtc is DateTime latest)
            {
                builder.OpenElement(seq++, "span");
                builder.AddAttribute(seq++, "class", "small text-muted");
                builder.AddContent(seq++, $"ล่าสุด: {FormatDate(latest)}");
                builder.CloseElement();
            }

            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "class", "badge bg-success text-white");
            builder.AddContent(seq++, $"ทั้งหมด {versions.Count} เวอร์ชัน");
            builder.CloseElement();

            builder.CloseElement();

            builder.CloseElement();

            if (versions.Count > 0)
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "version-timeline");

                for (var i = 0; i < versions.Count; i++)
                {
                    var version = versions[i];
                    var versionClasses = "version-node";
                    if (i == 0)
                    {
                        versionClasses += " latest";
                    }

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", versionClasses);

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", "version-content");

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", "d-flex justify-content-between align-items-start flex-wrap gap-2");

                    builder.OpenElement(seq++, "span");
                    builder.AddAttribute(seq++, "class", "fw-semibold");
                    builder.AddContent(seq++, $"Division {version.Division:D2}");
                    builder.CloseElement();

                    builder.OpenElement(seq++, "span");
                    builder.AddAttribute(seq++, "class", "small text-muted");
                    builder.AddContent(seq++, FormatDate(version.UploadedUtc));
                    builder.CloseElement();

                    builder.CloseElement();

                    builder.OpenElement(seq++, "div");
                    builder.AddAttribute(seq++, "class", "small text-muted");
                    builder.AddContent(seq++, version.FileName);
                    builder.CloseElement();

                    if (!string.IsNullOrWhiteSpace(version.Comment))
                    {
                        builder.OpenElement(seq++, "div");
                        builder.AddAttribute(seq++, "class", "version-comment");
                        builder.AddContent(seq++, version.Comment);
                        builder.CloseElement();
                    }

                    builder.CloseElement();
                    builder.CloseElement();
                }

                builder.CloseElement();
            }

            builder.CloseElement();
        };
    }

    private static List<BranchEditStatusResponse> OrderBranches(IEnumerable<BranchEditStatusResponse> branches)
        => branches
            .OrderByDescending(b => b.LastModifiedUtc ?? DateTime.MinValue)
            .ThenBy(b => b.Name, StringComparer.CurrentCultureIgnoreCase)
            .ToList();

    private static string FormatDate(DateTime? value)
        => value.HasValue ? value.Value.ToLocalTime().ToString("g") : "-";

    private static string FormatDate(DateTime value)
        => value.ToLocalTime().ToString("g");


    private sealed class LineEditStatusResponse
    {
        public string Line { get; set; } = string.Empty;
        public BranchEditStatusResponse? Root { get; set; }
        public string? ErrorMessage { get; set; }
    }

    private sealed class BranchEditStatusResponse
    {
        public string Name { get; set; } = string.Empty;
        public List<string> PathSegments { get; set; } = new();
        public int PdfCount { get; set; }
        public int TotalPdfCount { get; set; }
        public DateTime? LastModifiedUtc { get; set; }
        public string Status { get; set; } = string.Empty;
        public List<FileEditStatusResponse> RecentFiles { get; set; } = new();
        public List<DocumentTimelineResponse> Documents { get; set; } = new();
        public List<BranchEditStatusResponse> Children { get; set; } = new();
        public string? ErrorMessage { get; set; }
    }

    private sealed class FileEditStatusResponse
    {
        public string FileName { get; set; } = string.Empty;
        public DateTime LastModifiedUtc { get; set; }
        public long SizeBytes { get; set; }
        public string RelativePath { get; set; } = string.Empty;
    }

    private sealed class DocumentTimelineResponse
    {
        public string BaseName { get; set; } = string.Empty;
        public DateTime? LatestUploadedUtc { get; set; }
        public List<VersionTimelineResponse> Versions { get; set; } = new();
    }

    private sealed class VersionTimelineResponse
    {
        public string FileName { get; set; } = string.Empty;
        public int Division { get; set; }
        public DateTime UploadedUtc { get; set; }
        public string Comment { get; set; } = string.Empty;
        public string RelativePath { get; set; } = string.Empty;
    }
}
